server {
    listen      77.246.156.40:80;
    server_name olimpvl.ru www.olimpvl.ru alimpvl.ru www.alimpvl.ru test.olimpvl.ru;
    root        /home/olimpvl/web/olimpvl.ru/public_html;
    index       index.php index.html index.htm;
    access_log  /var/log/nginx/domains/olimpvl.ru.log combined;
    access_log  /var/log/nginx/domains/olimpvl.ru.bytes bytes;
    error_log   /var/log/nginx/domains/olimpvl.ru.error.log error;

         if ($host = 'www.olimpvl.ru' ) {
              rewrite ^(.*)$ http://olimpvl.ru$1 permanent;
        }
    #    location / {
    #            try_files       $uri $uri/ @bitrix;
    #    }
        
        location / { try_files $uri $uri/ /bitrix/urlrewrite.php$is_args$args; }

        location ~* /upload/.*\.(php|php3|php4|php5|php6|phtml|pl|asp|aspx|cgi|dll|exe|shtm|shtml|fcg|fcgi|fpl|asmx|pht|py|psp|rb|var)$ {
                types {
                        text/plain text/plain php php3 php4 php5 php6 phtml pl asp aspx cgi dll exe ico shtm shtml fcg fcgi fpl asmx pht py psp rb var;
                }
        }

        location ~ \.php$ {
                try_files       $uri @bitrix;
                fastcgi_pass    127.0.0.1:9001;
                fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
                fastcgi_param PHP_ADMIN_VALUE "sendmail_path = /usr/sbin/sendmail -t -i -f w@test.olimpvl.ru";
                include fastcgi_params;
        }
        location @bitrix {
                
                fastcgi_pass    127.0.0.1:9001;
                include fastcgi_params;
                fastcgi_param SCRIPT_FILENAME $document_root/bitrix/urlrewrite.php;
                fastcgi_param PHP_ADMIN_VALUE "sendmail_path = /usr/sbin/sendmail -t -i -f wm@test.olimpvl.ru";
        }
        location ~* /bitrix/admin.+\.php$ {
                try_files       $uri @bitrixadm;
                fastcgi_pass    127.0.0.1:9001;
                fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
                fastcgi_param PHP_ADMIN_VALUE "sendmail_path = /usr/sbin/sendmail -t -i -f wm@test.olimpvl.ru";
                include fastcgi_params;
        }
        location @bitrixadm{
                fastcgi_pass    127.0.0.1:9001;
                include fastcgi_params;
                fastcgi_param SCRIPT_FILENAME $document_root/bitrix/admin/404.php;
                fastcgi_param PHP_ADMIN_VALUE "sendmail_path = /usr/sbin/sendmail -t -i -f wm@test.olimpvl.ru";
        }

        location = /favicon.ico {
                log_not_found off;
                access_log off;
        }

        location = /robots.txt {
                allow all;
                log_not_found off;
                access_log off;
        }
        #
        # block this locations for any installation
        #

        # ht(passwd|access)
        location ~* /\.ht  { deny all; }

        # repositories
        location ~* /\.(svn|hg|git) { deny all; }

        # bitrix internal locations
        location ~* ^/bitrix/(modules|local_cache|stack_cache|managed_cache|php_interface) {
          deny all;
        }

        # upload files
        location ~* ^/upload/1c_[^/]+/ { deny all; }

        # use the file system to access files outside the site (cache)
        location ~* /\.\./ { deny all; }
        location ~* ^/bitrix/html_pages/\.config\.php { deny all; }
        location ~* ^/bitrix/html_pages/\.enabled { deny all; }

        # Intenal locations
        location ^~ /upload/support/not_image   { internal; }

        # Cache location: composite and general site
        location ~* @.*\.html$ {
          internal;
          # disable browser cache, php manage file
          expires -1y;
          add_header X-Bitrix-Composite "Nginx (file)";
        }

        # Player options, disable no-sniff
        location ~* ^/bitrix/components/bitrix/player/mediaplayer/player$ {
          add_header Access-Control-Allow-Origin *;
        }

        # Accept access for merged css and js
        location ~* ^/bitrix/cache/(css/.+\.css|js/.+\.js)$ {
          expires 30d;
          error_page 404 /404.html;
        }

        # Disable access for other assets in cache location
        location ~* ^/bitrix/cache              { deny all; }

        # Use nginx to return static content from s3 cloud storage
        # /upload/bx_cloud_upload/<schema>.<backet_name>.<s3_point>.amazonaws.com/<path/to/file>
        location ^~ /upload/bx_cloud_upload/ {
          location ~ ^/upload/bx_cloud_upload/(http[s]?)\.([^/:]+)\.(s3|s3-us-west-1|s3-eu-west-1|s3-ap-southeast-1|s3-ap-northeast-1)\.amazonaws\.com/(.+)$ {
                internal;
                resolver 8.8.8.8;
                proxy_method GET;
                proxy_set_header    X-Real-IP               $remote_addr;
                proxy_set_header    X-Forwarded-For         $proxy_add_x_forwarded_for;
                proxy_set_header    X-Forwarded-Server      $host;
                #proxy_max_temp_file_size 0;
                proxy_pass $1://$2.$3.amazonaws.com/$4;
          }
          location ~* .*$       { deny all; }
        }
        # Static content
        location ~* ^/(upload|bitrix/images|bitrix/tmp) {
          expires 30d;
        }
        
        location ~* ^.+\.(jpg|jpeg|gif|png|svg|js|css|woff2|webp)$ 
        {
          if ( $http_accept ~* webp ) {
            set $webp "A";
              }
                if ( $request_filename ~ (.+)\.(png|jpe?g)$ ) {
            	set $file_without_ext $1;
            	  }
            	    if ( -f $file_without_ext.webp ) {
            		set $webp "${webp}E";
            		  }
            		    if ( $webp = AE ) {
            			add_header Vary Accept;
            			    rewrite ^(.+)\.(png|jpe?g)$ $1.webp break;
            			      }
            			        expires 365d;
            			        }


#location ~* \.(jpg|jpeg|png|tiff|gif|webp|xml|html|yml|ogg|ogv|svg|svgz|eot|otf|woff|woff2|mp4|ttf|rss|atom|ico|zip|tgz|gz|rar|bz2|doc|xls|exe|ppt|tar|mid|midi|wav|rtf|pdf|txt|js|css|bmp|pnm|pbm|ppm)$ {
#    access_log off;
#	expires 97d;
#	}

        location = /404.html {
                access_log off ;
        }



    include     /etc/nginx/conf.d/phpmyadmin.inc*;
#    include     /etc/nginx/conf.d/phppgadmin.inc*;
#    include     /etc/nginx/conf.d/webmail.inc*;

    include     /home/olimpvl/conf/web/nginx.olimpvl.ru.conf*;
}
